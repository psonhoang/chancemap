<% extend('../defaultLayouts/defaultLayout') %>

<div class="app-content content container-fluid">
  <div class="col-xl-12">
    <div class="sidebar-left sidebar-fixed ps-container ps-theme-dark" data-ps-id="03674ca8-d455-878f-efc6-2c1d320c2753">
      <div class="sidebar">
        <div class="sidebar-content card hidden-md-down">
          <div class="card-block chat-fixed-search">
            <fieldset class="form-group position-relative has-icon-left m-0">
                <input type="text" class="form-control" id="iconLeft4" placeholder="Search user">
                <div class="form-control-position">
                    <i class="ft-search"></i>
                </div>
            </fieldset>
          </div>
          <div id="users-list" class="list-group position-relative" style="max-height: 660px; overflow-y: auto; -ms-overflow-style: -ms-autohiding-scrollbar">
            <div class="users-list-padding">
              <% connected.forEach( user => { %>
                <a id="<%=user._id%>" onclick="startChatting(<%= JSON.stringify(user._id) %>, <%= JSON.stringify(user.name) %>); " class="list-group-item list-group-item-action media no-border">
                  <div class="media-left">
                      <span class="avatar avatar-md avatar-away"><img class="media-object rounded-circle" src="<%= user.avatar %>" alt="Generic placeholder image">
                      </span>
                  </div>
                  <div class="media-body">
                      <h6 class="list-group-item-heading"><%= user.name %> <span class="font-small-3 float-xs-right primary">Yesterday</span></h6>
                      <p class="list-group-item-text text-muted"><i class="ft-check font-small-2"></i> Some message here</p>
                  </div>
                </a>
              <% }) %>
            </div>
          </div>
        </div>
      </div>
      <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 3px;">
        <div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div>
      </div>
      <div class="ps-scrollbar-y-rail" style="top: 0px; height: 820px; right: 3px;">
        <div class="ps-scrollbar-y" tabindex="0" style="top: 82px; height: 738px;"></div>
      </div>
    </div>

    <div class="content-right">
      <div class="content-wrapper">
        <div class="content-header row">
        </div>
        <div class="content-body">
          <div class="user-chatting" style="width: 100%; padding-top: 40px; background-color: #DCDCDC"></div>
          <!-- chat area -->
          <section class="chat-app-form">
            <!-- this is where messages appear -->
            <section id="chatroom">

            </section>
            <!-- this is where user types their messages -->
            <form class="chat-app-input" style="position: fixed; bottom: 0; width: 62%; padding-bottom: 20px">
              <fieldset id="chatbox" class="form-group col-xs-10 m-0">
                <div class="form-control-position">
                  <i class="icon-emoticon-smile"></i>
                </div>
                <input id="message" type="text" value="" class="form-control" placeholder="Type your message"></input>
                <div class="form-control-position control-position-right">
                </div>
              </fieldset>
              <fieldset class="form-group position-relative has-icon-left col-xs-2 m-0">
                <button id="send_message" onclick="clearText();" type="button" class="btn btn-primary"><i class="fa fa-paper-plane-o hidden-lg-up"></i>
                  <span class="hidden-md-down">Send</span>
                </button>
              </fieldset>
            </form>
          </section>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- script stuff -->
<script src="scripts/suggest.js" type="text/javascript"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  $(document).ready(function() {
    $('.user-chatting').hide();
    // chat function
    var socket = io();
    var chatroom = $('#chatroom');
    var message = $('#message');
    var send_message = $('#send_message');
    var user_ids = [];
    var user_id = $('#5b2906bbf2970c0744983404')
    // ids.forEach(id => {
    //   var temp_id =
    // })

    // var chatbox = $('#chatbox');

    // connecting to other users' rooms through their ids
    socket.on('connect', () => {
      if(<%- JSON.stringify(account_type) %> == 0) {
        let chats = <%- JSON.stringify(ids) %> + "";
        socket.emit('chats', chats);

        // sending a private message to a user
        // ids.forEach(id => {
        //   let user_id = '#' + id + '2';
        //   $(user_id).click(() => {
        //     socket.emit('private chat', {_id: id});
        //     connected.findOne({'_id': id} (err, privateUser) => {
        //       let name = privateUser.name;
        //     })
        //     //sending messages
        //     send_message.click((id, name) => {
        //       socket.emit('private message', {_id: id, name: name, message: message.val()});
        //     })
        //   })
        // })
      }
    })

    // sending a private message to a user
    // ids.forEach(id => {
    //   let user_id = '#' + id + '2';
    //   $(user_id).click(() => {
    //     socket.emit('private chat', {_id: id});
    //     connected.findOne({'_id': id} (err, privateUser) => {
    //       let name = privateUser.name;
    //     })
    //     //sending messages
    //     send_message.click((id, name) => {
    //       socket.emit('private message', {_id: id, name: name, message: message.val()});
    //     })
    //   })
    // })

    // socket.on('new private message', (data) => {
    //   chatroom.append('<p>' + <%- JSON.stringify(currentAcc.name) %> + ' said to ' + data.name + ': ' + data.message + '</p>');
    // })

    //sending messages
    // send_message.click(() => {
    //   socket.emit('new_message', {message: message.val()});
    // })
    //
    // socket.on('new_message', (data) => {
    //   chatroom.append('<p>' + <%- JSON.stringify(currentAcc.name) %> + ': ' + data.message + '</p>');
    // })

    //sending private messages
    user_id.click(() => {
      socket.emit('join private', {room_id: '5b2906bbf2970c0744983404'});
    })
    send_message.click(() => {
      socket.emit('private message', {room_id: '5b2906bbf2970c0744983404', user_name: 'SH', message: message.val()});
    })
    socket.on('new private message', (data) => {
      chatroom.append('<p>' + <%- JSON.stringify(currentAcc.name) %> + ' said to ' + data.user_name + ': ' + data.message + '</p>');
      socket.emit('success', {message: 'messaged sent!'});
    })

    // send_message.click(() => {
    //   socket.emit('private message', {room_id, user_name, message: message.val()})
    // })
    // socket.on('new private message', (data) => {
    //   chatroom.append('<p>' + <%- JSON.stringify(currentAcc.name) %> + ' said to ' + data.user_name + ': ' + data.message + '</p>');
    // })
  })

  function startChatting(user_id, user_name) {
    $('.user-chatting').show();
    $('.user-chatting').html(user_name);

    //emit a private chatroom for the user clicked
    //currentSocket.emit('join private', {room_id: user_id, user_name});

    //socket.emit('join_room', {_id: user_id});
  }
  function clearText() {
    setTimeout(function() {
      message.value = '';
    },0)
  }
</script>
