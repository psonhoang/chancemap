<% extend('../defaultLayouts/defaultLayout') %>

<div class="app-content content container-fluid">
  <div class="col-xl-12">
    <div class="sidebar-left sidebar-fixed ps-container ps-theme-dark" data-ps-id="03674ca8-d455-878f-efc6-2c1d320c2753">
      <div class="sidebar">
        <div class="sidebar-content card hidden-md-down">
          <div class="card-block chat-fixed-search">
            <fieldset class="form-group position-relative has-icon-left m-0">
                <input type="text" class="form-control" id="iconLeft4" placeholder="Search user">
                <div class="form-control-position">
                    <i class="ft-search"></i>
                </div>
            </fieldset>
          </div>
          <div id="users_list" class="list-group position-relative" style="max-height: 660px; overflow-y: auto; -ms-overflow-style: -ms-autohiding-scrollbar">

          </div>
        </div>
      </div>
      <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 3px;">
        <div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div>
      </div>
      <div class="ps-scrollbar-y-rail" style="top: 0px; height: 820px; right: 3px;">
        <div class="ps-scrollbar-y" tabindex="0" style="top: 82px; height: 738px;"></div>
      </div>
    </div>

    <div class="content-right">
      <div class="content-wrapper">
        <div class="content-header row">
        </div>
        <div class="content-body">
          <!-- where the current conversation is shown -->
          <div id="current_chat" style="width: 100%; padding-top: 40px; background-color: #DCDCDC"></div>
          <!-- chat area -->
          <section class="chat-app-form">
            <!-- this is where messages appear -->
            <section id="chatroom">

            </section>
            <!-- this is where user types their messages -->
            <form id="chatbox" class="chat-app-input" autocomplete="off" style="position: fixed; bottom: 0; width: 62%; padding-bottom: 20px">
              <!-- input box -->
              <fieldset class="form-group col-xs-10 m-0">
                <div class="form-control-position">
                  <i class="icon-emoticon-smile"></i>
                </div>
                <input id="message" type="text" value="" class="form-control" placeholder="Type your message"></input>
                <div class="form-control-position control-position-right">
                </div>
              </fieldset>
              <!-- send button -->
              <fieldset class="form-group position-relative has-icon-left col-xs-2 m-0">
                <button id="send_message" type="button" class="btn btn-primary"><i class="fa fa-paper-plane-o hidden-lg-up"></i>
                  <span class="hidden-md-down">Send</span>
                </button>
              </fieldset>
            </form>
          </section>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- script stuff -->
<script src="scripts/suggest.js" type="text/javascript"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  $(document).ready(function() {
    $('#current_chat').hide();

    // chat function
    var socket = io();
    var chatroom = $('#chatroom');
    var message = $('#message');
    var send_message = $('#send_message');
    var chatbox = $('#chatbox');
    var current_user_name = $('#current_user_name').html();
    var users_list = $('#users_list');
    var current_chat = $('#current_chat');

    //loading all chatable users
    socket.on('new connection', (data) => {
      let currentSocket = data.currentSocket;
      let connectedUsers = data.connectedUsers.slice();
      connectedUsers.forEach(user => {
        let room_id = user.id;
        let name = user.name;
        users_list.append('<li ' + 'id="' + room_id + '">' + name + '</li>');
        let button_id = '#' + room_id;
        $(button_id).bind('click', () => {
          // alert(name);
          socket.emit('join private', room_id);
          current_chat.show();
          current_chat.html(name);
        })
      })
    })

    //sending a message
    chatbox.submit((e) => {
      e.preventDefault();
      // private messaging
      if (current_chat.html() != '') {
        socket.emit('private message', {
          message: message.val(),
          name: current_chat.html(),
        });
        // normal messaging
      } else {
        socket.emit('chat message', {
          message: message.val()
        });
      }
      message.val('');
      return false;
    });

    //displaying the message onscreen
    socket.on('chat message', (data) => {
      let message = data.message;
      let name = data.name;
      let new_message = `${name}: ${message}`;
      chatroom.append('<li>' + new_message + '</li>');
    })

    //show private message on the screen
    socket.on('private message', (data) => {
      let message = data.message;
      let sender = data.sender;
      let recipient = data.recipient;
      // alert(`${sender} to ${recipient}: ${message}`);
      let new_log = `${sender} to ${recipient}: ${message}`;
      chatroom.append('<li>' + new_log + '</li>');
    })
  })
</script>
