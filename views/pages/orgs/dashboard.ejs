<% extend('../../defaultLayouts/defaultLayout.ejs'); %>
<% var months = ["January", "February", "March", "April", "May", "June", "July","August", "September", "October","November", "December"]; %>

<!-- Facebook embedding script -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0';
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div class="app-content content container-fluid">
	<div class="content-wrapper">
	  <div class="content-header row">
	    <div class="content-header-left col-md-6 col-xs-12 mb-2">
	      <h3 class="content-header-title mb-0">Organizations</h3>
	      <div class="row breadcrumbs-top">
	        <div class="breadcrumb-wrapper col-xs-12">
	          <ol class="breadcrumb">
	            <li class="breadcrumb-item"><a href="/">Home</a>
	            </li>
	            <li class="breadcrumb-item"><a href="/job">Dashboard</a>
	            </li>
	            <li class="breadcrumb-item active">Orgs
	            </li>
	          </ol>
	        </div>
	      </div>
	    </div>
	   </div>

		   	<!-- <div class="row"> -->
		        <div style="margin-bottom: 20px;" class="row container-fluid">
		          <div class="col-xl-10 col-xs-12">
		              <div id="search-input" class="edit-on-delete form-control tagging" data-tags-input-name="add-box">
		                <input class="type-zone" contenteditable="true">
		              </div>
		              <p class="text-muted">Search for orgs with keywords (Ex: charity, design, culture,...)</p>
		          </div>
		          <button onclick="search()" class="col-xl-2 col-xs-12 btn btn-info" type="button"><i class="ft-search font-md-4"></i> Search</button>
		        </div>
		    <!-- </div> -->
	</div>

 	<div class="content-body">
	 	<div class="col-md-12">
	        <!-- Orgs -->
	        <div style="margin-left: 5px; margin-right: 5px">
	          <div class="card">
	              <div style="color: white" class="card-header bg-teal">
	                <h4 class="card-title"><i class="ft-users"></i> Organizations</h4>
	                <a class="heading-elements-toggle">
	                  <i class="fa fa-ellipsis-v font-medium-3"></i>
	                </a>
	              </div>
	              <div class="card-body collapse-in">
	                <div class="table-responsive">
	                  <table class="table">
	                    <thead style="color: white" class="thead bg-blue-grey bg-darken-3">
	                      <tr>
	                        <th>Avatar</th>
	                        <th style="text-align: center">Organization</th> <!-- Includes info: event name, org, location, time, tags -->
	                        <th>#</th>
	                      </tr>
	                    </thead>
	                    <tbody id="orgsBody">
	                      <% orgs.forEach(org => { %>
													<% if (org.username != currentAcc.username) { %>
														<% let cardId = org._id; %>
														<tr>
	                            <td>
	                            	<img src="<%= org.avatar; %>" class="rounded-circle width-100 height-100" alt="org avatar">
																<% if(account_type == 0) { %>
		                                <br><br>
		                                <buton id="<%= org._id %>" onclick="follow(<%= JSON.stringify(currentAcc._id) %>, <%= JSON.stringify(org._id) %>)" class="btn btn-info"><i class="fa fa-eye"></i> Follow</buton>
		                            <% } %>
	                            </td>          
	                            <td class="btn-secondary" style="border: 0" onclick="window.location.href='orgs/<%= org._id %>'">
	                              <ul>
	                                <li style="font-size: 16px"><strong><%= org.name %></strong></li>
	                                <li style="font-style: italic">@<%= org.username %></li>
	                                <% if (org.facebook) { %>
	                                  <li style="font-style: small"><i class="ft-facebook"></i> <%= org.facebook %></li>
	                                <% } %>
	                                <% if (org.email) { %>
	                                  <li style="font-size: small;"><i class="ft-mail"></i> <%= org.email %></li>
	                                <% } %>
	                                <% if (org.website) { %>
	                                  <li style="font-size: small"><i class="ft-globe"></i> <%= org.website %></li>
	                                <% } %>
	                                <li style="font-size: small">About: <%= org.desc %></li>
	                              </ul>
	                            </td>
	                            <td>
	                              <% org.hashtags.forEach(hashtag => { %>
	                                <% var isMatch = false; %>
	                                <% criteriaList.forEach(criteria => { %>
	                                  <% if (hashtag.includes(criteria) && !isMatch) { %>
	                                    <% isMatch = true; %>
	                                    <span style="font-size: 14px" class="tag tag-pill tag-warning"><%= hashtag; %></span>
	                                  <% } %>
	                                <% }); %>
	                                <% if (!isMatch) { %>
	                                  <span style="font-size: 14px" class="tag tag-pill tag-info"><%= hashtag; %></span>
	                                <% } %>
	                              <% }); %>
	                            </td>
														</tr>
	                        <% } %>
	                      <% }) %>
	                    </tbody>
	                  </table>
	                </div>
	              </div>
	          </div>
	        </div>		
		</div>
	</div>

</div>

<!--  BEGIN CODEDAO SCRIPT -->
<script>

	// function vieworg (index) {
	// console.log("click!");
	// let modal = document.getElementById("orgModal" + index);
	// modal.style.display = "block";
	// }

	// When the user clicks anywhere outside of the modal, close it
	// window.onclick = function(event) {
	// 	let i,j;
	// 	let modals = document.getElementsByClassName("orgModal");
	// 	let modalsContent = document.getElementsByClassName("orgModalContent");
	// 	for (i = 0; i < modals.length; i++) {
	// 		if (event.target == modals[i] || event.target.parentNode == modals[i] || event.target.parentNode == modalsContent[i]) {
	// 			let orgModal = document.getElementById("orgModal" + i);
	// 			orgModal.style.display = "none";
	// 		}
	// 	};
	// }

  $(document).ready(function() {
    $('#search-input').tagging('removeAll');
  });

  function follow(user_id, org_id) {
    let button_id = '#' + org_id;
    $(button_id).removeClass('btn-info');
    $(button_id).addClass('btn-success');
    $(button_id).html('<i class="fa fa-check"></i> Followed');
		// alert('user: ' + user_id + '; org: ' + org_id);
		let form = document.createElement('form');
		form.setAttribute("method", 'POST');
		form.setAttribute("action", '/follow');
		
		let idField = document.createElement('input');
		idField.setAttribute("type", "hidden");
		idField.setAttribute("name", 'org_id');
		idField.setAttribute("value", org_id);

		let userField = document.createElement('input');
		userField.setAttribute("type", "hidden");
		userField.setAttribute("name", 'user_id');
		userField.setAttribute("value", user_id);

		form.appendChild(idField);
		form.appendChild(userField);
		document.body.appendChild(form);
		form.submit();
  }

  function search() {
    let x = document.getElementById('search-input');
    let tags = x.getElementsByTagName('div');
    let criteriaList = [];
    let inputValue;
    for (var i = 0; i < tags.length; i++) {
      inputValue = tags[i].getElementsByTagName('input')[0].value;
      criteriaList.push(inputValue);
    }
    // alert(criteriaList);
    if(criteriaList.length > 0) {
    	$.ajax({
	      async: true,
	      url: '/search/orgs',
	      method: 'GET',
	      beforeSend: (req) => {
	        $.blockUI();
	      },
	      data: {
	        criteriaList: criteriaList
	      },
	      success: (data) => {
	        console.log(typeof(data));
	        document.open();
	        document.write(data);
	        document.close();
	        $.unblockUI();
	      }
	    });
    } else {
      toastr.warning("Your search field can't be empty!", 'Error!', {positionClass: 'toast-top-center', containerId: 'toast-top-center'});
    }
  }
</script>
<!-- END -->

