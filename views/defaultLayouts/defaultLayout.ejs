<!DOCTYPE html>
<html lang="en" data-textdirection="ltr" class="loading">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>
      <%= title %>
    </title>
    <link rel="apple-touch-icon" href="../../../app-assets/images/ico/apple-icon-120.png">
    <link rel="shortcut icon" type="image/x-icon" href="/images/logo.ico">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,400i,500,500i%7COpen+Sans:300,300i,400,400i,600,600i,700,700i" rel="stylesheet">
    <!-- BEGIN VENDOR CSS-->
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/fonts/feather/style.min.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/fonts/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/fonts/flag-icon-css/css/flag-icon.min.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/extensions/pace.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/ui/prism.min.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/forms/tags/bootstrap-tagsinput.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/forms/tags/tagging.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/forms/icheck/icheck.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/forms/icheck/custom.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/extensions/toastr.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/vendors/css/calendars/fullcalendar.min.css">
    <!-- END VENDOR CSS-->
    <!-- BEGIN STACK CSS-->
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/bootstrap-extended.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/app.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/colors.css">
    <!-- END STACK CSS-->
    <!-- BEGIN Page Level CSS-->
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/core/menu/menu-types/vertical-menu.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/core/menu/menu-types/vertical-overlay-menu.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/core/colors/palette-gradient.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/pages/login-register.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/pages/search.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/plugins/extensions/toastr.css">
    <link rel="stylesheet" type="text/css" href="../../../app-assets/css/plugins/calendars/fullcalendar.css">
    <!-- END Page Level CSS-->
    <!-- BEGIN Custom CSS-->
    <link rel="stylesheet" type="text/css" href="../../../assets/css/style.css">
    <link rel="stylesheet" type="text/css" href="../../../assets/css/autocomplete.css">
    <!-- END Custom CSS-->
    <!-- BEGIN CODEDAO CSS -->
    <link rel="stylesheet" type="text/css" href="/stylesheets/main.css">
    <link href="https://fonts.googleapis.com/css?family=Josefin+Sans|Josefin+Slab" rel="stylesheet">
    <!-- END -->
    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- END -->
  </head>

  <body data-open="click" data-menu="vertical-menu" data-col="2-columns" class="vertical-layout vertical-menu 2-columns menu-expanded fixed-navbar">
    <!-- navbar-fixed-top-->
    <nav class="header-navbar navbar navbar-with-menu navbar-fixed-top navbar-dark">
      <div class="navbar-wrapper">
        <div class="navbar-header">
          <ul class="nav navbar-nav">
            <li class="nav-item mobile-menu hidden-md-up float-xs-left"><a href="#" class="nav-link nav-menu-main menu-toggle hidden-xs"><i class="ft-menu font-large-1"></i></a></li>
            <li id="brandTitle" class="nav-item"><a href="/" class="navbar-brand"><img alt="stack admin logo" src="/images/w_logo.png" witdh="16" height="32" class="brand-logo">
                <h2 class="brand-text">ChanceMap</h2>
              </a></li>
            <li class="nav-item hidden-md-up float-xs-right"><a data-toggle="collapse" data-target="#navbar-mobile" class="nav-link open-navbar-container"><i class="fa fa-ellipsis-v"></i></a></li>
          </ul>
        </div>
        <div class="navbar-container content container-fluid">
          <div id="navbar-mobile" class="collapse navbar-toggleable-sm">
            <ul class="nav navbar-nav">
              <li class="nav-item hidden-sm-down"><a id="menuToggle" href="#" class="nav-link nav-menu-main menu-toggle hidden-xs"><i class="ft-menu"></i></a></li> <!-- Menu Toggle -->
              <li class="nav-item hidden-sm-down"><a href="#" class="nav-link nav-link-expand"><i class="ficon ft-maximize"></i></a></li>
            </ul>
            <ul style="margin-right: 50px" class="nav navbar-nav float-xs-right">

              <% if(!currentAcc.hashtags) { %>
              <!-- user connect noti -->
              <li class="dropdown dropdown-notification nav-item">
                <a id="msg_noti" href="#" data-toggle="dropdown" class="nav-link nav-link-label"><i class="ficon ft-users"></i>
                  <!-- <span class="noti_count tag tag-pill tag-default tag-danger tag-default tag-up">0</span> -->
                  <% if(currentAcc.connect_received) { %>
                  <span class="noti_count tag tag-pill tag-default tag-danger tag-default tag-up">
                    <%= currentAcc.connect_received.length %>
                  </span>
                  <% } else { %>
                  <span class="noti_count tag tag-pill tag-default tag-danger tag-default tag-up">
                    0
                  </span>
                  <% } %>
                </a>

                <ul class="dropdown-menu dropdown-menu-media dropdown-menu-right">
                  <li class="dropdown-menu-header">
                    <h6 class="dropdown-header m-0"><span class="grey darken-2">Requests</span>
                  </li>
                  <li id="connect_noti" class="list-group scrollable-container ps-container ps-theme-dark ps-active-y" data-ps-id="f63177ae-103d-18cc-b7ba-6373aaa089ef">
                    <% let connectRequests = users.filter(user => currentAcc.connect_received.indexOf(user.username) >= 0) %>
                    <% connectRequests.forEach(user => { %>
                    <% if (account_type == 0 && currentAcc.connected.indexOf(user.username) < 0 && currentAcc.connect_sent.indexOf(user.username) < 0 && currentAcc.connect_received.indexOf(user.username) >= 0) { %>
                    <a id="<%=user._id%>-connect" href="javascript:void(0)" class="list-group-item">
                      <div class="media-body">
                        <div class="media-left valign-middle">
                          <img src="<%= user.avatar %>" class="media-object rounded-circle" style="max-width: 40px; max-height: 40px" />
                        </div>
                        <div class="media-left">
                          <strong>
                            <%= user.name %>
                          </strong>
                          <br><br>
                          <button class="connect_button btn btn-info" onclick="acceptRequest(<%= JSON.stringify(currentAcc._id) %>, <%= JSON.stringify(user._id) %>, <%= JSON.stringify(user.username) %>)">Accept</button>
                        </div>
                      </div>
                    </a>
                    <%  } %>
                    <% }) %>

                    <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 3px;">
                      <div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                    </div>
                    <div class="ps-scrollbar-y-rail" style="top: 0px; height: 255px; right: 3px;">
                      <div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 167px;"></div>
                    </div>
                  </li>
                  <li class="dropdown-menu-footer"><a href="/messages" class="dropdown-item text-muted text-xs-center">See all requests</a></li>
                </ul>
              </li>
              <% } %>


              <!-- messages noti -->
              <li onclick="clearMsgNoti()" class="dropdown dropdown-notification nav-item">
                <% let myMessages = messages.filter(message => message.recipient === currentAcc.name) %>
                <a id="msg_noti" href="#" data-toggle="dropdown" class="nav-link nav-link-label"><i class="ficon ft-message-square"></i>
                  <span class="noti_count tag tag-pill tag-default tag-danger tag-default tag-up">0</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-media dropdown-menu-right">
                  <li class="dropdown-menu-header">
                    <h6 class="dropdown-header m-0"><span class="grey darken-2">Messages</span>
                  </li>
                  <li id="msg_noti_box" class="list-group scrollable-container ps-container ps-theme-dark ps-active-y" data-ps-id="f63177ae-103d-18cc-b7ba-6373aaa089ef">
                    <% let chatters = [] %>
                    <% let conversations = [] %>

                    <% myMessages.forEach(message => { %>
                    <%  chatters.push(message.sender) %>
                    <% }) %>
                    <% let allConversations = connected.filter(user => chatters.indexOf(user.name) >= 0) %>

                    <% allConversations.forEach(conversation => { %>

                    <%  let user_id = conversation._id %>
                    <%  let avatar = conversation.avatar %>

                    <%  let receivedMessages = myMessages.filter(message => message.sender === conversation.name) %>
                    <%  receivedMessages.sort((a, b) => { %>
                    <%    return a.sort_value - b.sort_value; %>
                    <%  }) %>

                    <%  let lastMessage = receivedMessages[receivedMessages.length - 1].message %>
                    <%  let name = receivedMessages[receivedMessages.length - 1].sender %>

                    <%  conversations.push({avatar, user_id, name, lastMessage}) %>
                    <% }) %>


                    <% conversations.forEach(conversation => { %>
                    <a href="javascript:void(0)" class="list-group-item">
                      <div class="media">
                        <div class="media-left valign-middle">
                          <img src="<%= conversation.avatar %>" class="media-object rounded-circle" style="max-width: 30px; max-height: 40px" />
                        </div>
                        <div id="<%= conversation.user_id %>-noti" class="media-body">
                          <p class="font-small-3 text-muted">
                            <strong>
                              <%= conversation.name %>
                            </strong>
                            <%= conversation.lastMessage %>
                          </p>
                        </div>
                      </div>
                    </a>
                    <% }) %>

                    <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 3px;">
                      <div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                    </div>
                    <div class="ps-scrollbar-y-rail" style="top: 0px; height: 255px; right: 3px;">
                      <div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 167px;"></div>
                    </div>
                  </li>
                  <li class="dropdown-menu-footer"><a href="/messages" class="dropdown-item text-muted text-xs-center">See all messages</a></li>
                </ul>
              </li>



              <!-- events and jobs noti -->
              <li onclick="clearNoti()" class="dropdown dropdown-notification nav-item">
                <a href="#" data-toggle="dropdown" class="nav-link nav-link-label"><i class="ficon ft-bell"></i>
                  <span class="noti_count tag tag-pill tag-default tag-danger tag-default tag-up">
                    <input id="noti_val" type="hidden" value="<%= currentAcc.new_notis.length %>">
                    <% if (currentAcc.new_notis) { %>
                    <%= currentAcc.new_notis.length %>
                    <% }  else { %>
                    <%= 0 %>
                    <% } %>
                  </span>
                </a>
                <ul class="dropdown-menu dropdown-menu-media dropdown-menu-right">
                  <li class="dropdown-menu-header">
                    <h6 class="dropdown-header m-0"><span class="grey darken-2">Notifications</span><span class="notification-tag tag tag-default tag-danger float-xs-right m-0" id="noti_dropdown">
                        <% if (currentAcc.new_notis) { %>
                        <%= currentAcc.new_notis.length %>
                        <% }  else { %>
                        <%= 0 %>
                        <% } %> new</span></span></h6>
                  </li>
                  <li id="noti" class="list-group scrollable-container ps-container ps-theme-dark ps-active-y" data-ps-id="f63177ae-103d-18cc-b7ba-6373aaa089ef">
                    <% if(notis) { %>
                    <% notis.reverse().forEach(noti => { %>
                    <a href="javascript:void(0)" class="list-group-item">
                      <div class="media">
                        <div class="media-left valign-middle">
                          <% if(noti.image == 'event') { %>
                          <i class="ft-calendar icon-bg-circle bg-amber"></i>
                          <% } else { %>
                          <i class="ft-clipboard icon-bg-circle bg-cyan"></i>
                          <% } %>
                        </div>
                        <div class="media-body">
                          <h6 class="media-heading">
                            <%= noti.title %>
                            <% if (currentAcc.new_notis) { %>
                            <% if (currentAcc.new_notis.indexOf(noti._id) > -1) { %>
                            <i style="color: orange" class="ft-bell"></i>
                            <% } %>
                            <% } %>
                          </h6>
                          <p class="notification-text font-small-3 text-muted">
                            <%= noti.body %>
                          </p>
                        </div>
                      </div>
                    </a>
                    <%});%>
                    <% } %>

                    <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 3px;">
                      <div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                    </div>
                    <div class="ps-scrollbar-y-rail" style="top: 0px; height: 255px; right: 3px;">
                      <div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 167px;"></div>
                    </div>
                  </li>
                  <li class="dropdown-menu-footer"><a href="/notifications" class="dropdown-item text-muted text-xs-center">Read all notifications</a></li>
                </ul>
              </li>


              <li class="dropdown dropdown-user nav-item"><a href="#" data-toggle="dropdown" class="dropdown-toggle nav-link dropdown-user-link">
                  <span class="avatar avatar-online">
                    <img src="<%= currentAcc.avatar; %>" alt="avatar">
                    <i></i>
                  </span>
                  <span class="user-name">
                    <%= currentAcc.username; %></span></a>
                <% if (account_type == 2) { %>
                <div class="dropdown-menu dropdown-menu-right"><a href="javascript:void(0);" class="dropdown-item"><i class="ft-user"></i> Edit Profile</a><a href="javascript:void(0);" class="dropdown-item"><i class="ft-bell"></i> Notifications</a>
                  <%} else {%>
                  <div class="dropdown-menu dropdown-menu-right"><a href="/profile" class="dropdown-item"><i class="ft-user"></i> Edit Profile</a><a href="/notifications" class="dropdown-item"><i class="ft-bell"></i> Notifications</a>
                    <%}%>
                    <div class="dropdown-divider"></div><a href="/logout" class="dropdown-item"><i class="ft-power"></i> Logout</a>
                  </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>
    <!-- ////////////////////////////////////////////////////////////////////////////-->
    <% if(account_type == 1) { %>
    <%- include('nav_menu_org'); %>
    <% } else if (account_type ==0){ %>
    <%- include('nav_menu_user'); %>
    <% } else { %>
    <%- include('nav_menu_admin'); %>
    <% } %>
    <%- content %>

    <!-- DEFAULT SCRIPTS -->

    <!-- BEGIN VENDOR JS-->
    <script src="../../../app-assets/vendors/js/vendors.min.js" type="text/javascript"></script>
    <!-- BEGIN VENDOR JS-->

    <!-- BEGIN PAGE VENDOR JS-->
    <script src="../../../app-assets/vendors/js/forms/validation/jqBootstrapValidation.js" type="text/javascript"></script>
    <script src="../../../app-assets/vendors/js/forms/icheck/icheck.min.js" type="text/javascript"></script>
    <script src="../../../app-assets/vendors/js/forms/tags/bootstrap-tagsinput.min.js" type="text/javascript"></script>
    <script src="../../../app-assets/vendors/js/forms/extended/typeahead/typeahead.bundle.min.js" type="text/javascript"></script>
    <script src="../../../app-assets/vendors/js/forms/tags/tagging.min.js" type="text/javascript"></script>
    <script src="../../../app-assets/vendors/js/ui/prism.min.js" type="text/javascript"></script>
    <script src="../../../app-assets/vendors/js/extensions/toastr.min.js" type="text/javascript"></script>
    <script src="../../../app-assets/vendors/js/extensions/moment.min.js" type="text/javascript"></script>
    <script src="../../../app-assets/vendors/js/extensions/fullcalendar.min.js" type="text/javascript"></script>
    <!-- END PAGE VENDOR JS-->

    <!-- BEGIN STACK JS-->
    <script src="../../../app-assets/js/core/app-menu.js" type="text/javascript"></script>
    <script src="../../../app-assets/js/core/app.js" type="text/javascript"></script>
    <!-- END STACK JS-->

    <!-- BEGIN PAGE LEVEL JS-->
    <script src="../../../app-assets/js/scripts/forms/form-login-register.js" type="text/javascript"></script>
    <script src="../../../app-assets/js/scripts/forms/tags/tagging.js" type="text/javascript"></script>
    <script src="../../../app-assets/js/scripts/extensions/toastr.js" type="text/javascript"></script>
    <!-- <script src="../../../app-assets/js/scripts/extensions/fullcalendar.js" type="text/javascript"></script> -->
    <!-- END PAGE LEVEL JS-->

    <!-- BEGIN CODEDAO SCRIPT -->
    <script src="/scripts/defaultLayout.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      $(document).ready(function() {
            var msg_noti = ('#msg_noti');
            var msg_noti_box = ('#msg_noti_box');

            $.blockUI({
              overlayCSS: {
                opacity: 0
              },
              message: ''
            });
            setTimeout(() => {
              $.unblockUI();
            }, 1500);
            // Socket.IO
            var socket = io();
            socket.on('connect', () => {
              if (<%- JSON.stringify(account_type) %> == 0) {
                let rooms = <%- JSON.stringify(currentAcc.following) %> + "";
                socket.emit('rooms', rooms);
              } else {
                let room = <%- JSON.stringify(currentAcc.username) %>;
                socket.emit('room', room);
                console.log('this is an org');
              }
            });

            socket.on('event', (noti) => {
              console.log(noti);
              if (noti.image == 'event') {
                $('#noti').prepend(
                  '<a href="javascript:void(0)" class="list-group-item">\
                    <div class="media">\
                      <div class="media-left valign-middle"><i class="ft-calendar icon-bg-circle bg-amber"></i></div>\
                      <div class="media-body">\
                        <h6 class="media-heading">' +
                  noti.title + ' <i style="color: orange" class="ft-bell"></i></h6>\
                        <p class="notification-text font-small-3 text-muted">' + noti.body +
                  '</p><small>\
                      </div>\
                    </div>\
                  </a>');
              } else if (noti.image == 'job') {
                $('#noti').prepend(
                  '<a href="javascript:void(0)" class="list-group-item">\
                    <div class="media">\
                      <div class="media-left valign-middle"><i class="ft-clipboard icon-bg-circle bg-cyan"></i></div>\
                      <div class="media-body">\
                        <h6 class="media-heading">' +
                  noti.title + ' <i style="color: orange" class="ft-bell"></i></h6>\
                        <p class="notification-text font-small-3 text-muted">' + noti.body +
                  '</p><small>\
                      </div>\
                    </div>\
                  </a>');
              }
              $('.noti_count').html(parseInt($('#nav_noti').html().trim()) + 1);
              $('#noti_dropdown').html(parseInt($('#noti_dropdown').html().trim()) + 1 + ' NEW');
            });

            //adding new connect noti
            socket.on('connect noti', (data) => {
              $('#connect_noti').prepend(
                `
                <a id="${data.user_id}-connect" href="javascript:void(0)" class="list-group-item">
                  <div class="media-body">
                    <div class="media-left valign-middle">
                      <img src="${data.avatar}" class="media-object rounded-circle" style="max-width: 40px; max-height: 40px" />
                    </div>
                    <div class="media-left">
                      <strong>
                        ${data.name}
                      </strong>
                      <button style="margin-left: 60px" class="connect_button btn btn-info">Accept</button>
                    </div>
                  </div>
                </a>
              `
              );
              let button_id = `#${data.user_id}-connect`;
              $(button_id).bind('click', () => {
                let click_id = '#' + data.user_id + '2';
                let click_id2 = '#' + data.user_id + '-connect';

                $(click_id2).remove();
                $(click_id).removeClass('btn-info');
                $(click_id).addClass('btn-success');
                $(click_id).html('Connected');
                $(click_id).attr('onclick', 'disconnect("' + account_id + '","' + user_id + '","' + user_username + '")');

                let formData = new FormData();
                formData.append("user_id", user_id);
                formData.append("account_id", account_id);
                formData.append('status', 'connect_accept');

                $.ajax({
                  async: true,
                  url: '/connect',
                  method: 'POST',
                  processData: false,
                  contentType: false,
                  data: formData,
                  success: (data) => {
                    toastr.success('You have connected with ' + user_username, 'Connected!');
                  }
                });
                socket.to(data.user_id).emit('success');
              });
            });

            var is_dropping = false;

            // Clear notifications
            function clearNoti() {
              let condition = $('#noti_val').val() != "0";
              is_dropping = !is_dropping;
              if (condition && !is_dropping) {
                $.ajax({
                  async: true,
                  url: '/clear-notifications',
                  method: 'GET',
                  data: {
                    account_id: <%- JSON.stringify(currentAcc._id) %>,
                    account_type: <%= account_type %>
                  },
                  success: (data) => {
                    console.log(data);
                    $('.noti_count').html(0);
                    $('#noti_dropdown').html('0 NEW');
                  }
                });
              }
            }

            // function clearMsgNoti() {
            //   alert('hi');
            //   messages.forEach(message => {
            //     if (message.recipient === currentAcc.name) {
            //       message.read = true;
            //       alert(message.read);
            //     }
            //   })
            //   $('#msg_noti').remove();
            // }
    </script>
    <!-- END -->
  </body>

</html>